<?xml version="1.0" encoding="iso-8859-1"?>
<wiki_article>
  <wiki_id>200</wiki_id>
  <wiki_id_contents>1211</wiki_id_contents>
  <wiki_title>Mettre à jour son module 4.0 en 4.1</wiki_title>
  <wiki_encoded_title>mettre-a-jour-son-module-4-0-en-4-1</wiki_encoded_title>
  <wiki_hits>1467</wiki_hits>
  <wiki_id_cat>41</wiki_id_cat>
  <wiki_is_cat>0</wiki_is_cat>
  <wiki_defined_status>0</wiki_defined_status>
  <wiki_undefined_status></wiki_undefined_status>
  <wiki_redirect>0</wiki_redirect>
  <wiki_auth></wiki_auth>
  <wiki_cat_id>41</wiki_cat_id>
  <wiki_cat_id_parent>5</wiki_cat_id_parent>
  <wiki_cat_article_id>144</wiki_cat_article_id>
  <wiki_con_id_contents>1211</wiki_con_id_contents>
  <wiki_con_id_article>200</wiki_con_id_article>
  <wiki_menu><ol class="wiki_list_1"><li><a href="#paragraph_le-fichier-de-configuration">Le fichier de configuration</a></li><li><a href="#paragraph_changements-dans-l-api">Changements dans l'API</a><ol class="wiki_list_2"><li><a href="#paragraph_systeme-de-categories">Système de catégories</a></li><li><a href="#paragraph_liens-dans-l-administration">Liens dans l'administration</a></li><li><a href="#paragraph_pagination">Pagination</a><ol class="wiki_list_3"><li><a href="#paragraph_fichiers-php">Fichiers php</a></li><li><a href="#paragraph_templates">Templates</a></li></ol></li><li><a href="#paragraph_notation">Notation</a></li></ol></li><li><a href="#paragraph_templates">Templates</a><ol class="wiki_list_2"><li><a href="#paragraph_tableaux">Tableaux</a></li><li><a href="#paragraph_icones">Icônes</a></li><li><a href="#paragraph_boutons">Boutons</a></li><li><a href="#paragraph_formulaires">Formulaires</a></li><li><a href="#paragraph_templates-des-pages">Templates des pages</a></li><li><a href="#paragraph_mini-modules">Mini-modules</a></li></ol></li></ol></wiki_menu>
  <wiki_activ>1</wiki_activ>
  <wiki_user_id>5193</wiki_user_id>
  <wiki_user_ip>88.125.157.163</wiki_user_ip>
  <wiki_timestamp>1404746880</wiki_timestamp>
  <wiki_content>[style=warning]Si aucun des éléments se trouvant dans cette documentation ne vous aide, référez-vous au forum et demandez de l'aide.[/style]
Cette documentation permet de rendre votre module compatible avec la version 4.1 de PHPBoost sans trop de modifications dans le code. Elle n'a pas pour but de le convertir en utilisant le modèle MVC et d'utiliser les nouvelles fonctionnalités. Effectuez les différentes étapes suivantes (peu importe l'ordre) pour mettre à jour votre module.

-- Le fichier de configuration --

Le seul changement à effectuer dans le fichier [i]/module/config.ini[/i] pour rendre votre module compatible avec la nouvelle version est le paramètre "compatibility". Remplacez la valeur par [b]4.1[/b].
Pensez également à mettre à jour le numéro de version de votre module pour plus de cohérence.
[code=text]compatibility="4.1"[/code]

-- Changements dans l'API --

--- Système de catégories ---

Si votre module fait appel au système de catégories, il faut changer l'appel à la classe [b]CategoriesManager[/b] en [b]DeprecatedCategoriesManager[/b] dans le fichier [i]/module/phpboost/ModuleCats.class.php[/i] :
[code=php]class DownloadCats extends DeprecatedCategoriesManager[/code]

--- Liens dans l'administration ---

Un nouveau système a été mis en place pour les liens dans l'administration. Ces liens apparaissent maintenant également sur le site à droite du fil d'ariane.

Pour le mettre en place, ajoutez la fonction suivante dans la classe du fichier [i]/module/phpboost/ModuleExtensionPointProvider.class.php[/i] (en remplaçant Module par le nom de votre module) :
[code=php]
public function tree_links()
{
	return new ModuleTreeLinks();
}
[/code]
Créez ensuite le fichier [i]/module/phpboost/ModuleTreeLinks.class.php[/i] (exemple pour le module download) :
[code=php]
&lt;?php
/*##################################################
 *		                         DownloadTreeLinks.class.php
 *                            -------------------
 *   begin                : November 23, 2013
 *   copyright            : (C) 2013 Julien BRISWALTER
 *   email                : julienseth78@phpboost.com
 *
 *
 ###################################################
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 *
 ###################################################*/

/**
 * @author Julien BRISWALTER &lt;julienseth78@phpboost.com&gt;
 */
class DownloadTreeLinks implements ModuleTreeLinksExtensionPoint
{
	public function get_actions_tree_links()
	{
		global $DOWNLOAD_LANG;
		load_module_lang('download'); //Chargement de la langue du module.
		require_once(PATH_TO_ROOT . '/download/download_auth.php');
		
		$tree = new ModuleTreeLinks();
		
		//Gestion et ajout de catégories dans l'administration
		$manage_categories_link = new AdminModuleLink($DOWNLOAD_LANG['admin.categories.manage'], new Url('/download/admin_download_cat.php'));
		$manage_categories_link-&gt;add_sub_link(new AdminModuleLink($DOWNLOAD_LANG['admin.categories.manage'], new Url('/download/admin_download_cat.php')));
		$manage_categories_link-&gt;add_sub_link(new AdminModuleLink($DOWNLOAD_LANG['add_category'], new Url('/download/admin_download_cat.php?new=1')));
		$tree-&gt;add_link($manage_categories_link);
		
		//Gestion et ajout de fichiers dans l'administration
		$manage_download_link = new AdminModuleLink($DOWNLOAD_LANG['files.manage'], new Url('/download/admin_download.php'));
		$manage_download_link-&gt;add_sub_link(new AdminModuleLink($DOWNLOAD_LANG['files.manage'], new Url('/download/admin_download.php')));
		$manage_download_link-&gt;add_sub_link(new AdminModuleLink($DOWNLOAD_LANG['add_file'], new Url('/download/management.php?new=1')));
		$tree-&gt;add_link($manage_download_link);
		
		//Gestion de la configuration du module dans l'administration
		$tree-&gt;add_link(new AdminModuleLink(LangLoader::get_message('configuration', 'admin'), new Url('/download/admin_download_config.php')));
		
		//Lien pour ajouter un fichier sur le site
		if (!AppContext::get_current_user()-&gt;check_level(User::ADMIN_LEVEL))
		{
			$tree-&gt;add_link(new ModuleLink($DOWNLOAD_LANG['add_file'], new Url('/download/management.php?new=1'), AppContext::get_current_user()-&gt;check_auth(DownloadConfig::load()-&gt;get_authorizations(), DOWNLOAD_WRITE_CAT_AUTH_BIT)));
		}
		
		return $tree;
	}
}
?&gt;
[/code]
[style=notice]La classe [code=php,0,1]AdminModuleLink()[/code] permet d'afficher des liens dans l'administration et sur le site pour les administrateurs.
La classe [code=php,0,1]ModuleLink()[/code] des liens uniquement sur la partie site (pas dans l'administration). Les limitations d'accès à ce lien sont définies dans le 3e paramètre.[/style]
Vous pouvez ensuite supprimer les liens [code=text,0,1]admin_links[/code] dans [i]/module/lang/french/desc.ini[/i] (idem pour les autres langues).

--- Pagination ---

L'API de pagination a été améliorée. Il faut faire des changements au niveau du code php et des templates pour l'utiliser parce-que l'ancienne API n'est plus supportée.
Si vous utilisiez la classe Pagination dans la version 4.0, veuillez maintenant passer à la nouvelle classe ModulePagination.

---- Fichiers php ----

Remplacez l'ancienne déclaration de la pagination :
[code=php]
$Pagination = new DeprecatedPagination();

$tpl-&gt;put_all(array(
	'PAGINATION' =&gt; $Pagination-&gt;display(PATH_TO_ROOT . '/module/page.php?p=%d', $number_elements, 'p', $_NBR_ELEMENTS_PER_PAGE, 3),
));
[/code]
Par :
[code=php]
$page = AppContext::get_request()-&gt;get_getint('p', 1);
$pagination = new ModulePagination($page, $number_elements, $_NBR_ELEMENTS_PER_PAGE);
$pagination-&gt;set_url(new Url('/module/page.php?p=%d'));
	
if ($pagination-&gt;current_page_is_empty() &amp;&amp; $page &gt; 1)
{
	$error_controller = PHPBoostErrors::unexisting_page();
	DispatchManager::redirect($error_controller);
}

$tpl-&gt;put_all(array(
	'C_PAGINATION' =&gt; $pagination-&gt;has_several_pages(),
	'PAGINATION' =&gt; $pagination-&gt;display(),
));
[/code]
La variable [code=php,0,1]$number_elements[/code] représente le nombre total d'éléments (généralement récupéré par une requête SQL avant) et la variable [code=php,0,1]$_NBR_ELEMENTS_PER_PAGE[/code] représente le nombre d'éléments à afficher sur la page (généralement défini dans la configuration du module).

Remplacez également la limitation du nombre de page dans la requête SQL :
[code=php]
$Sql-&gt;limit($Pagination-&gt;get_first_msg($_NBR_ELEMENTS_PER_PAGE, 'p'), $_NBR_ELEMENTS_PER_PAGE)
[/code]
Par :
[code=php]
$Sql-&gt;limit($pagination-&gt;get_display_from(), $_NBR_ELEMENTS_PER_PAGE)
[/code]

---- Templates ----

Remplacez l'appel à la pagination dans les templates [code=tpl,0,1]{PAGINATION}[/code] par :
[code=tpl]
# IF C_PAGINATION # # INCLUDE PAGINATION # # ENDIF #
[/code]

--- Notation ---

La fonction [code=php,0,1]set_average_notes()[/code] a été ajoutée dans la classe [b]Notation[/b].
Initialisation de la notation :
[code=php]
$notation = new Notation();
$notation-&gt;set_module_name('module');
$notation-&gt;set_id_in_module($id);
$notation-&gt;set_notation_scale($max_note);

$result = $Sql-&gt;query_while("SELECT module.*, notes.average_notes
FROM " . PREFIX . "module module
LEFT JOIN " . DB_TABLE_AVERAGE_NOTES . " notes ON module.id = notes.id_in_module AND notes.module_name = 'module'", __LINE__, __FILE__);

while ($row = $Sql-&gt;fetch_assoc($result))
{
	$notation-&gt;set_id_in_module($row['id']);
	$notation-&gt;set_average_notes($row['average_notes']);
}
[/code]
Appel de la notation active (notation lors du clic) :
[code=php]
$tpl-&gt;put_all(array(
	'NOTE' =&gt; NotationService::display_active_image($notation),
));
[/code]
Appel de la notation statique (affichage uniquement) :
[code=php]
$tpl-&gt;put_all(array(
	'NOTE' =&gt; NotationService::display_static_image($notation),
));
[/code]
-- Templates --

Il y a eu pas mal de changements dans le nom des classes CSS. La plupart du temps il suffit de remplacer le _ par un -. Référez-vous à la documentation des thèmes pour plus d'informations.
[list]
  [*][code=tpl,0,1]text_strong[/code] devient [code=tpl,0,1]text-strong[/code]
  [*][code=tpl,0,1]text_center[/code] devient [code=tpl,0,1]center[/code]
  [*][code=tpl,0,1]text_small[/code] devient [code=tpl,0,1]smaller[/code]
[/list]

--- Tableaux ---

Les classes CSS [b]module-table[/b], [b]row1[/b], [b]row2[/b] et [b]row3[/b] ont été supprimées et le style des tableaux a été mis à jour pour respecter les standards.
Un tableau doit être de la forme :
[code=tpl]
&lt;table&gt;
	&lt;caption&gt;Titre du tableau&lt;/caption&gt;
	&lt;thead&gt;
		&lt;tr&gt;
			&lt;th&gt;Titre&lt;/th&gt;
		&lt;/tr&gt;
	&lt;/thead&gt;
	&lt;tfoot&gt;
		&lt;tr&gt;
			&lt;th&gt;Pied de page&lt;/th&gt;
		&lt;/tr&gt;
	&lt;/tfoot&gt;
	&lt;tbody&gt;
		&lt;tr&gt;
			&lt;td&gt;Contenu&lt;/td&gt;
		&lt;/tr&gt;
	&lt;tbody&gt;
&lt;/table&gt;
[/code]
[style=notice]La déclaration du pied de page se fait bien avant la déclaration du contenu, ce n'est pas une erreur. Les sections [b]caption[/b], [b]thead[/b] et [b]tfoot[/b] ne sont pas obligatoires. Le style des tableaux se personnalise dans les fichiers CSS du thème (voir la documentation sur les thèmes).[/style]

--- Icônes ---

Les images des thèmes ont été remplacées par des icônes de la librairie [url=http://fontawesome.io/icons/]Font-Awesome[/url].
Vous pouvez avoir un aperçu des différentes icônes utilisées dans les modules dans le module [b]bac à sable[/b].

[u]Principaux changements[/u] :
Remplacez :
[code=tpl]
&lt;img src="{PATH_TO_ROOT}/templates/{THEME}/images/{LANG}/edit.png" class="valign_middle" /&gt;
&lt;img src="{PATH_TO_ROOT}/templates/{THEME}/images/{LANG}/delete.png" class="valign_middle" /&gt;
&lt;img src="{PATH_TO_ROOT}/templates/{THEME}/images/refresh.png" alt="" /&gt;
[/code]
Par :
[code=tpl]
&lt;i class="fa fa-edit"&gt;&lt;/i&gt;
&lt;i class="fa fa-delete"&gt;&lt;/i&gt;
&lt;i class="fa fa-refresh fa-2x"&gt;&lt;/i&gt;
[/code]

--- Boutons ---

Les boutons des formulaires doivent être mis à jour pour respecter la sémantique HTML5.
Remplacez :
[code=tpl]
&lt;input type="submit" name="valid" value="{L_SUBMIT}" class="submit"&gt;
&amp;nbsp;&amp;nbsp;
&lt;input value="{L_PREVIEW}" onclick="XMLHttpRequest_preview();" class="submit" type="button"&gt;
&amp;nbsp;&amp;nbsp;
&lt;input type="reset" value="{L_RESET}" class="reset"&gt;
[/code]
Par :
[code=tpl]
&lt;button type="submit" name="valid" value="true"&gt;{L_SUBMIT}&lt;/button&gt;
&lt;button type="button" value="{L_PREVIEW}" onclick="XMLHttpRequest_preview();"&gt;{L_PREVIEW}&lt;/button&gt;
&lt;button type="reset" value="true"&gt;{L_RESET}&lt;/button&gt;
[/code]

--- Formulaires ---

Certaines parties des formulaires ont été mises à jour. Le plus gros changement consiste à remplacer les _ dans les noms des classes CSS par des -.
Remplacez :
[code=tpl]
&lt;dl&gt;
	&lt;dt&gt;
		&lt;label for="name"&gt;{L_NAME}&lt;/label&gt;
		&lt;br /&gt;
		&lt;span class="test_small"&gt;{L_NAME_EXPLAIN}&lt;/span&gt;
	&lt;/dt&gt;
	&lt;dd&gt;
		&lt;input type="text" size="65" maxlength="100" id="name" name="name" value="{NAME}" class="text"&gt;
	&lt;/dd&gt;	
&lt;/dl&gt;
[/code]
Par :
[code=tpl]
&lt;div class="form-element"&gt;
	&lt;label for="name"&gt;
		{L_NAME}
		&lt;span class="field-description"&gt;{L_NAME_EXPLAIN}&lt;/span&gt;
	&lt;/label&gt;
	&lt;div class="form-field"&gt;
		&lt;input type="text" size="65" maxlength="100" id="name" name="name" value="{NAME}"&gt;
	&lt;/div&gt;	
&lt;/div&gt;
[/code]

--- Templates des pages ---

L'affichage des pages a été mis à jour pour respecter les standards HTML5.
Remplacez :
[code=tpl]
&lt;div class="module_position"&gt;
	&lt;div class="module_top_l"&gt;&lt;/div&gt;
	&lt;div class="module_top_r"&gt;&lt;/div&gt;
	&lt;div class="module_top"&gt;Titre&lt;/div&gt;
	&lt;div class="module_contents"&gt;
		Contenu
	&lt;/div&gt;
	&lt;div class="module_bottom_l"&gt;&lt;/div&gt;
	&lt;div class="module_bottom_r"&gt;&lt;/div&gt;
	&lt;div class="module_bottom"&gt;&lt;/div&gt;
&lt;/div&gt;
[/code]
Par :
[code=tpl]
&lt;section&gt;
	&lt;header&gt;
		&lt;h1&gt;Titre&lt;/h1&gt;
	&lt;/header&gt;
	&lt;div class="content"&gt;
		Contenu
	&lt;/div&gt;
	&lt;footer&gt;&lt;/footer&gt;
&lt;/section&gt;
[/code]

--- Mini-modules ---

Remplacez les _ dans les noms des classes CSS par des -. Ce qui donne :
[code=tpl]
&lt;div class="module-mini-container"# IF C_HORIZONTAL # style="width:auto;"# ENDIF #&gt;
	&lt;div class="module-mini-top"&gt;
		&lt;h5 class="sub-title"&gt;Titre&lt;/h5&gt;
	&lt;/div&gt;
	&lt;div class="module-mini-contents"&gt;
		Contenu
	&lt;/div&gt;
	&lt;div class="module-mini-bottom"&gt;&lt;/div&gt;
&lt;/div&gt;
[/code]</wiki_content>
</wiki_article>