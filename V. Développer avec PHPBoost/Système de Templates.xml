<?xml version="1.0" encoding="iso-8859-1"?>
<wiki_article>
  <wiki_id>37</wiki_id>
  <wiki_id_contents>963</wiki_id_contents>
  <wiki_title>Système de Templates</wiki_title>
  <wiki_encoded_title>systeme-de-templates</wiki_encoded_title>
  <wiki_hits>1220</wiki_hits>
  <wiki_id_cat>5</wiki_id_cat>
  <wiki_is_cat>0</wiki_is_cat>
  <wiki_defined_status>0</wiki_defined_status>
  <wiki_undefined_status></wiki_undefined_status>
  <wiki_redirect>0</wiki_redirect>
  <wiki_auth></wiki_auth>
  <wiki_cat_id>5</wiki_cat_id>
  <wiki_cat_id_parent>0</wiki_cat_id_parent>
  <wiki_cat_article_id>159</wiki_cat_article_id>
  <wiki_con_id_contents>963</wiki_con_id_contents>
  <wiki_con_id_article>37</wiki_con_id_article>
  <wiki_menu><ol class="wiki_list_1"><li><a href="#paragraph_la-syntaxe-des-templates">La syntaxe des templates</a></li><li><a href="#paragraph_texte-simple">Texte simple</a></li><li><a href="#paragraph_variables">Variables</a><ol class="wiki_list_2"><li><a href="#paragraph_variable-simple">Variable Simple</a></li><li><a href="#paragraph_variable-de-langue">Variable de langue</a></li></ol></li><li><a href="#paragraph_conditions">Conditions</a><ol class="wiki_list_2"><li><a href="#paragraph_condition-simple">Condition simple</a><ol class="wiki_list_3"><li><a href="#paragraph_le-template">Le template</a></li></ol></li><li><a href="#paragraph_condition-negative">Condition négative</a></li></ol></li><li><a href="#paragraph_boucles">Boucles</a><ol class="wiki_list_2"><li><a href="#paragraph_boucle-simple">Boucle simple</a></li><li><a href="#paragraph_boucle-simple-avec-des-variables">Boucle simple avec des variables</a></li><li><a href="#paragraph_boucles-imbriquees">Boucles imbriquées</a></li></ol></li><li><a href="#paragraph_inclusions">Inclusions</a><ol class="wiki_list_2"><li><a href="#paragraph_inclusion-directe">Inclusion directe</a><ol class="wiki_list_3"><li><a href="#paragraph_le-template">Le template</a></li><li><a href="#paragraph_le-template-a-inclure">Le template à inclure</a></li><li><a href="#paragraph_le-php">Le PHP</a></li><li><a href="#paragraph_le-resultat">Le résultat</a></li></ol></li><li><a href="#paragraph_inclusion-dans-une-boucle">Inclusion dans une boucle</a><ol class="wiki_list_3"><li><a href="#paragraph_le-template">Le template</a></li></ol></li></ol></li><li><a href="#paragraph_expressions-qui-ecrivent-dans-le-template">Expressions qui écrivent dans le template</a><ol class="wiki_list_2"><li><a href="#paragraph_methodes-de-templates">Méthodes de templates</a></li><li><a href="#paragraph_methode-statique">Méthode statique</a></li></ol></li><li><a href="#paragraph_expressions-qui-n-ecrivent-pas-dans-le-template">Expressions qui n'écrivent pas dans le template</a><ol class="wiki_list_2"><li><a href="#paragraph_association-d-un-fichier-de-langue">Association d'un fichier de langue</a></li></ol></li><li><a href="#paragraph_php">PHP</a><ol class="wiki_list_2"><li><a href="#paragraph_exemple">Exemple</a></li></ol></li><li><a href="#paragraph_les-templates-en-php">Les Templates en PHP</a></li><li><a href="#paragraph_creation-instanciation-d-un-objet-template">Création / instanciation d'un objet Template</a><ol class="wiki_list_2"><li><a href="#paragraph_a-partir-d-un-fichier-filetemplate">A partir d'un fichier : FileTemplate</a></li><li><a href="#paragraph_a-partir-d-une-chaine-de-caractere-stringtemplate">A partir d'une chaîne de caractère : StringTemplate</a></li></ol></li><li><a href="#paragraph_assignation-automatique">Assignation automatique</a></li><li><a href="#paragraph_compatibilite">Compatibilité</a></li></ol></wiki_menu>
  <wiki_activ>1</wiki_activ>
  <wiki_user_id>1393</wiki_user_id>
  <wiki_user_ip>88.125.157.163</wiki_user_ip>
  <wiki_timestamp>1386876575</wiki_timestamp>
  <wiki_content>Afin d'offrir de nouvelles possibilités, le moteur de template de PHPBoost 4.0 a été entièrement revu.

Cette page décrit en détails les possibilités (les nouvelles comme les anciennes) offertes par le moteur de template de PHPBoost.

-- La syntaxe des templates --

Un template se compose de différents éléments de syntaxe.
[list]
[*] Du texte simple
[*] Des variables
[*] Des conditions
[*] Des boucles
[*] Des inclusions de sous-templates
[*] Des expressions qui écrivent dans le template
[*] Des expressions qui n'écrivent pas dans le template
[*] Du PHP
[/list]

-- Texte simple --

[code=tpl]Il est possible d'écrire du texte simplement dans un template, c'est le contenu par défaut[/code]
Le résultat :
[code=html]Il est possible d'écrire du texte simplement dans un template, c'est le contenu par défaut[/code]
[style=notice]Il est possible d'échapper des caractères spéciaux qui pourraient être interprétés par le moteur de template en les faisant précéder par un antislash : &#8220;\&#8221;.

La liste des caractères spéciaux qu'il peut être nécessaire d'échapper est la suivante : \, $, #, {, }[/style]

-- Variables --
Le moteur de templates supporte différents types de variables. Dans cette partie, nous détaillerons les variables simples et les variables de langues.

--- Variable Simple ---
Une variable simple sera remplacée par la valeur assignée à la variable côté PHP.
[code=tpl]Il est possible d'écrire du texte avec des {VARS}[/code]
[code=php]$template-&gt;put('VARS', 'variables');[/code]
Le résultat :
[code=html]Il est possible d'écrire du texte avec des variables[/code]

--- Variable de langue ---
[code=tpl]#{resources('monmodule/meslangues')}
{@hello.world}[/code]
Le fichier de langues associé se trouvant dans le répertoire /monmodule/french/meslangues.php
[code=php]$lang = array('hello.world' =&gt; 'Bonjour');[/code]
Le résultat :
[code=html]Bonjour[/code]
Dans cette exemple on voit deux choses. Tout d'abord, il faut associer la langue au Template avec la méthode resources qui prend en argument le chemin vers la langue à charger. Cette langue sera prise en compte à l'exécution pour savoir si il faut aller la chercher dans le répertoire french, english ou autre.

[style=notice]Ceci peut également se faire directement en PHP. L'exemple suivant est équivalent :
[code=tpl]{@hello.world}[/code]
[code=php]$template-&gt;add_lang(LangLoader::get('meslangues', 'monmodule'));[/code]
Le fichier de langue associé se trouvant dans le répertoire /monmodule/french/meslangues.php
[code=php]$lang = array('hello.world' =&gt; 'Bonjour');[/code][/style]
Ici, la variable de langue est appelée en utilisant la syntaxe @nomDeLaVariableDeLangue. Cette syntaxe est un raccourci pour l'appel i18n('nomDeLaVariableDeLangue'). Cette seconde méthode sera détaillée dans la partie méthode de template.

-- Conditions --
Le moteur de templates supporte les conditions de type IF (not) une condition / ELSE. La condition peut être une variable, une constante, ou bien le retour d'une méthode.

--- Condition simple ---
---- Le template ----
[code=tpl]# IF VAR1 #
la variable "VAR1" vaut TRUE
# ELSE #
la variable "VAR1" vaut FALSE
# END #
[/code]
[code=php]$template-&gt;put('VAR1',  true);[/code]
Le résultat :
[code=html]la variable "VAR1" vaut TRUE[/code]

--- Condition négative ---
[code=tpl]# IF NOT DayTime::is_lunch_time() #
Ce n'est pas l'heure de manger
# ELSE #
A table
# END #
[/code]
Le résultat si la statique méthode [code=php,0,1]DayTime::is_lunch_time()[/code] retourne [code=php,0,1]false[/code]
[code=html]A table[/code]

-- Boucles --
--- Boucle simple ---
[code=tpl]# START boucle #
Code répété dans la boucle
# END boucle #[/code]
[code=php]$my_loop = array();
for ($i = 0; $i &lt; 3; $i++) {
    $my_loop[] = array();
}
$template-&gt;put('boucle', $my_loop);[/code]
Le résultat :
[code=html]Code répété dans la boucle
Code répété dans la boucle
Code répété dans la boucle[/code]

--- Boucle simple avec des variables ---
[code=tpl]Nom de la boucle : ${LOOP_NAME}
# START boucle #
${boucle.I} * 2 = ${boucle.2I}
# END boucle #[/code]
[code=php]$template-&gt;put('LOOP_NAME' =&gt; 'table de 2');
$my_loop = array();
for ($i = 0; $i &lt; 3; $i++) {
    $my_loop[] = array('I' =&gt; $i, '2I' =&gt; $i * 2));
}
$template-&gt;put('boucle', $my_loop);[/code]
Le résultat :
[code=html]Nom de la boucle : table de 2
0 * 2 = 0
1 * 2 = 2
2 * 2 = 4[/code]

--- Boucles imbriquées ---
[code=tpl]# START boucle1 #
Code répété dans la boucle 1: {boucle1.VARBOUCLE_1}
    # START boucle1.boucle2 #
    Code répété dans la boucle 2: {boucle1.boucle2.VARBOUCLE_2}
    # END boucle1.boucle2 #
# END boucle1 #[/code]
[code=php]$loop1 = array();
for ($i = 1; $i &lt;= 3; $i++) {
   $loop2 = array();
   for ($j = 1; $j &lt;= 2; $j++) {
       $loop2[] = array('VARBOUCLE_2' =&gt; $j);
   }
   $loop1[] = array('VARBOUCLE_1' =&gt; $i, 'boucle2' =&gt; $loop2);
}
$template-&gt;put('boucle1', $loop1);
[/code]
Le résultat :
[code=html]Code répété dans la boucle 1: 1
    Code répété dans la boucle 2: 1
    Code répété dans la boucle 2: 2
Code répété dans la boucle 1: 2
    Code répété dans la boucle 2: 1
    Code répété dans la boucle 2: 2
Code répété dans la boucle 1: 3
    Code répété dans la boucle 2: 1
    Code répété dans la boucle 2: 2[/code]

-- Inclusions --
--- Inclusion directe ---
---- Le template ----
[code=tpl]Ceci est # INCLUDE SUBTEMPLATE # dans un autre[/code]
---- Le template à inclure ----
[code=tpl]un template inclus[/code]
---- Le PHP ----
[code=php]$subtemplate = // un objet de type Template ou View
$template-&gt;put('SUBTEMPLATE', $subtemplate);[/code]
---- Le résultat ----
[code=html]Ceci est un template inclus dans un autre[/code]

--- Inclusion dans une boucle ---
---- Le template ----
[code=tpl]Ceci est # START loop # # INCLUDE loop.SUBTEMPLATE # # END # dans un autre[/code]
Le premier template à inclure
[code=tpl]un temp[/code]
Le second template à inclure
[code=tpl]late inclus[/code]
Le PHP
[code=php]$subtemplates = array($subtemplate1, $subtemplate2); // Objets de type Template ou View
$loop = array();
for ($subtemplates as $subtemplate) {
   $loop[] = array('SUBTEMPLATE' =&gt; $subtemplate);
}
$template-&gt;put('loop', $loop);[/code]
Le résultat :
[code=html]Ceci est un template inclus dans un autre[/code]

-- Expressions qui écrivent dans le template --
Les expressions permettent d'appeler du PHP directement depuis un template. Ceci est utile car cela permet de ne plus assigner les langues dans le PHP et de mettre en forme les messages directement dans les templates.

Pour cela, il est possible d'appeler soit des fonctions de templates, soit des méthodes statiques sur de vraies classes PHP.

--- Méthodes de templates ---
Les méthodes de templates sont des méthodes qui permettent d'appeler certains services directement depuis le template. Voici la liste de ces méthodes :

[list]
[*] resources(String languageFile) : Charge le fichier de langue et l'associé au template.
[*] i18n(String messageId) : retourne le message de langue identifier par l'identifiant messageId trouvé dans les fichiers de langues chargés par la méthode resources() ci-dessus. Le caractères XML '&lt;', '&gt;', '"' et '&amp;' sont échappés
[*] i18nraw(String messageId) : pareil que i18n, mais n'échappe pas le xml
[*] i18njs(String messageId) :  pareil que i18n mais échappe les "'" et les "\n"
[*] i18njsraw(String messageId) :  pareil que i18nraw mais échappe les "'" et les "\n"
[*] setvars(String message, String[String] variables) : remplace les occurences des éléments de la forme ":nom" par la valeur associée à la clé "nom" dans le dictionnaire variables
[*] escape(String message) : échappe le xml
[*] escapejs(String message, boolean add_quotes = true) : échappe le javascript. Par défaut, la chaîne résultante est entourée de 'simples guillements'
[/list]
Pour plus d'informations sur ces méthodes, il faut se reporter à la PHPDoc de la classe TemplateFunctions

[code=tpl]${i18n('welcome.message')}[/code]
Le résultat :
[code=html]Le message de bienvenue contenu dans le fichier langue[/code]

--- Méthode statique ---
[code=tpl]${LangLoader::get_message('step.welcome.message', 'install', 'install')}[/code]
Le résultat :
[code=html]Bienvenue dans l'assistant d'installation de PHPBoost[/code]

-- Expressions qui n'écrivent pas dans le template --
Si l'on comprend bien  l'intérêt des expressions pour modifier la mise en page des variables passées au template, il est peut-être plus difficile de comprendre l'intérêt des expressions qui n'écrivent rien dans les templates. Pourtant elles sont également très importantes.

En effet, pour associer un fichier de langue à un template, on peut soit le faire en PHP, soit directement dans le template. Dans le cas où cela se fait directement dans le template, aucun élément ne sera à écrire dans le template.

--- Association d'un fichier de langue ---
[code=tpl]#{resources('install/install')}
&lt;h1&gt;${i18n('step.welcome.message')}&lt;/h1&gt;[/code]
Le résultat:
[code=html]&lt;h1&gt;Bienvenue dans l'assistant d'installation de PHPBoost&lt;/h1&gt;[/code]
Dans le cas ou le #{resources()} n'aurait pas été fait, il aurait fallut faire cette association en php de la façon suivante : [code=php]$template-&gt;add_lang(LangLoader::get('install', 'install'));[/code]
Si aucune de ces deux méthodes n'est employée alors un message d'erreur indiquera que la langue n'a pas été trouvée.

-- PHP --
Il est possible d&#8217;inclure du PHP dans les templates, cependant, ceci est à proscrire pour plusieurs raisons :

[list=ordered]
[*] Cela risque fort de mener à avoir des traitements dans le template qui n&#8217;ont rien à voir avec la mise en page, ce qui rend la future maintenance du module beaucoup plus compliquée, car en plus de changer la logique dans le code PHP du module, il faudra également retravailler de façon approfondie les templates.
[*] Cela n&#8217;est pas performant. En effet le moteur de rendu de PHPBoost permet d&#8217;afficher le template directement avec une instruction echo, ou bien de pouvoir l&#8217;injecter ailleurs en donnant un rendu sous forme de chaîne de caractères. Ce second cas rend la gestion des echos qui pourraient être fait dans le code PHP appelé très compliquée .
[*] La solution utilisée par le moteur de templates pour supporter ces echos consiste à stocker dans le buffer de sortie ce qui va être écrit. Or l&#8217;opération visant à préserver ce buffer est extrêmement coûteuse en terme de performances.
[/list]
Si malgré ceci vous avez tout de même besoin d&#8217;utiliser du PHP dans vos templates, voici un exemple.

--- Exemple ---
[code=tpl]ceci est du &lt;?php echo ?PHP?; ?&gt;[/code]
Le résultat :
[code=html]ceci est du PHP[/code]

-- Les Templates en PHP --
Nous venons de voir comment écrire des templates et quels étaient les mécanismes PHP pour communiquer avec ceux-ci.

Nous allons maintenant voir quelques fonctionnalités côté PHP permettant de créer un objet Template et l'utiliser assez simplement.

-- Création / instanciation d'un objet Template --
--- A partir d'un fichier : FileTemplate ---
[code=php]$my_template = new FileTemplate('mymodule/mytpl.tpl');[/code]
Ce bout de code va chercher à créer un objet Template en utilisant le premier fichier de template existant.

[list=ordered]
[*] /templates/$theme/modules/mymodule/mytpl.tpl : C&#8217;est le fichier de template fourni par le thème utilisé. Il est utilisé prioritairement s'il est trouvé car il est en accord avec le thème.
[*] /mymodule/templates/mytpl.tpl : C&#8217;est le fichier de template fourni par le module à utiliser si le thème ne propose pas sa propre version.
[/list]

--- A partir d'une chaîne de caractère : StringTemplate ---
[code=php]$my_template = new StringTemplate('Ceci est mon template');[/code]

Dans les deux cas précédent, un objet template à été créé. Il se comportement indifféremment, peu importe que le template soit issu d&#8217;un fichier ou d&#8217;une chaîne de caractères.

-- Assignation automatique --
Afin de faciliter le travail des développeurs, un certain nombre de variables sont assignés au template par défaut. En voici la liste :

[list]
[*] THEME : le nom du dossier du thème courant
[*] LANG : le nom du dossier de la langue courante
[*] IS_USER_CONNECTED : true si l&#8217;utilisateur est connecté
[*] IS_ADMIN : true si l'utilisateur est un administrateur
[*] IS_MODERATOR : true si l'utilisateur est un modérateur
[*] PATH_TO_ROOT : le chemin jusqu&#8217;à la racine de PHPBoost
[*] TOKEN : le token de session permettant de se prémunir des attaques CSRF. Pour plus d&#8217;informations, lire [wikipedia]Cross-Site Request Forgery[/wikipedia]
[/list]

-- Compatibilité --
Le moteur de templates de PHPBoost 4.0 est (presque) entièrement compatible avec les templates de la version 3.0.

[style=notice]Ceci signifie que tous les templates de la 3.0 continueront à fonctionner sans nécessiter d'adaptation sur la 4.0 (à de rares exceptions près).
Pour adapter un thème 3.0 en version 4.0, utilisez cette procédure : [link=mettre-a-jour-son-theme-3-0-en-4-0]Mettre à jour son thème 3.0 en 4.0[/link]
[/style]</wiki_content>
</wiki_article>